name: FastAPI CD

on:
  workflow_run:
    workflows: [ "FastAPI CI" ]
    types: [ completed ]
    branches: [ develop ]

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ----------------------------
      # 1. AWS ì¸ì¦
      # ----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2
          
      # ----------------------------
      # 2. S3ì—ì„œ ìµœì‹  artifact ë‹¤ìš´ë¡œë“œ
      # ----------------------------
      - name: Download artifact from S3
        env:
          BUCKET: ${{ secrets.RELEASE_BUCKET }}
          PREFIX: releases/ai
        run: |
          rm -rf ./artifact
          mkdir -p ./artifact

          # latest í´ë”ì—ì„œ artifact ë™ê¸°í™”
          aws s3 cp "s3://$BUCKET/$PREFIX/latest/" ./artifact/ --recursive

          echo "Downloaded from s3://$BUCKET/$PREFIX/latest/"
          ls -la ./artifact | head

      # ----------------------------
      # 3. ì„œë²„ë¡œ ë°°í¬ (ë°±ì—…/ë¡¤ë°± ëŒ€ë¹„)
      # ----------------------------
      - name: Prepare server directories (backup)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e
            echo "=== FastAPI Deploy Start ==="

            TARGET_DIR="/home/ubuntu/ai"
            BACKUP_DIR="/home/ubuntu/ai_backup"

            # ë°±ì—… (ë¡¤ë°± ëŒ€ë¹„)
            rm -rf "$BACKUP_DIR"
            if [ -d "$TARGET_DIR" ]; then
              cp -r "$TARGET_DIR" "$BACKUP_DIR"
              echo "Backup completed"
            fi

            # ê¸°ì¡´ íŒŒì¼ ì œê±°
            rm -rf "$TARGET_DIR"
            mkdir -p "$TARGET_DIR"

      - name: List AI files
        run: ls -la artifact && find artifact -maxdepth 2 -type f | head

      # ----------------------------
      # 4. artifact ì—…ë¡œë“œ
      # ----------------------------
      - name: Upload artifact files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          source: "artifact/**"
          target: "/home/ubuntu/ai"
          strip_components: 1

      # ----------------------------
      # 5. FastAPI Restart
      # ----------------------------
      - name: Restart FastAPI
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -euo pipefail
            cd /home/ubuntu/ai

            # uv ì„¤ì¹˜ (ì—†ìœ¼ë©´)
            if ! command -v uv >/dev/null 2>&1; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi

            # ì˜ì¡´ì„± ì„¤ì¹˜/ì—…ë°ì´íŠ¸
            uv sync

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID íŒŒì¼ ì‚¬ìš©)
            if [ -f uvicorn.pid ]; then
              OLD_PID=$(cat uvicorn.pid)
              if ps -p "$OLD_PID" >/dev/null 2>&1; then
                kill "$OLD_PID" || true
                sleep 3
              fi
              rm -f uvicorn.pid
            fi

            # ìƒˆë¡œ ì‹¤í–‰í•˜ê³  PID ì €ì¥
            nohup uv run uvicorn api.main:app --host 0.0.0.0 --port 8000 > ai.log 2>&1 &
            echo $! > uvicorn.pid
            echo "FastAPI restarted (PID: $(cat uvicorn.pid))"
			
			# ----------------------------
      # 6. Health Check
      # ----------------------------
      - name: Health check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "Health Check ì‹œì‘ (10ì´ˆ ëŒ€ê¸°)..."
            sleep 10

            # 3íšŒ ì¬ì‹œë„ (10ì´ˆ ê°„ê²©)
            for i in 1 2 3; do
              echo "Health Check ì‹œë„ $i/3"
              if curl -sf http://localhost:8000 > /dev/null; then
                echo "Health Check ì„±ê³µ"
                exit 0
              fi
              sleep 10
            done

            echo "Health Check ì‹¤íŒ¨"
            exit 1

      # ----------------------------
      # 7. Rollback
      # ----------------------------
      - name: Rollback on failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e
            TARGET_DIR="/home/ubuntu/ai"
            BACKUP_DIR="/home/ubuntu/ai_backup"

            # í˜„ì¬ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            if [ -f "$TARGET_DIR/uvicorn.pid" ]; then
              OLD_PID=$(cat "$TARGET_DIR/uvicorn.pid")
              if ps -p "$OLD_PID" >/dev/null 2>&1; then
                kill "$OLD_PID" || true
                sleep 3
              fi
              rm -f "$TARGET_DIR/uvicorn.pid"
            fi

            # ë°±ì—… ë³µêµ¬
            if [ -d "$BACKUP_DIR" ]; then
              rm -rf "$TARGET_DIR"
              mv "$BACKUP_DIR" "$TARGET_DIR"
              echo "Rollback completed"
            else
              echo "Rollback failed: no backup"
              exit 1
            fi

            # ë¡¤ë°± í›„ ì¬ì‹œì‘
            cd "$TARGET_DIR"

            if ! command -v uv >/dev/null 2>&1; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi

            uv sync

            nohup uv run uvicorn api.main:app --host 0.0.0.0 --port 8000 > ai.log 2>&1 &
            echo $! > uvicorn.pid
            echo "FastAPI restarted after rollback (PID: $(cat uvicorn.pid))"

      # ----------------------------
      # 8. Discord ì•Œë¦¼
      # ----------------------------
      - name: Notify Discord - Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "ğŸš€ AI ë°°í¬ ì„±ê³µ"
          description: "S3 latest ê¸°ë°˜ ë°°í¬ ì™„ë£Œ"

      - name: Notify Discord - Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "ğŸš¨ AI ë°°í¬ ì‹¤íŒ¨"
          description: "Health check ì‹¤íŒ¨ ë˜ëŠ” ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
