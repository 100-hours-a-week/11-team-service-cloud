name: Frontend CD

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]
    branches: [develop]

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ----------------------------
      # 1. AWS ì¸ì¦
      # ----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      # ----------------------------
      # 2. S3ì—ì„œ ìµœì‹  dist ë‹¤ìš´ë¡œë“œ
      # ----------------------------
      - name: Download artifact from S3
        env:
          BUCKET: ${{ secrets.RELEASE_BUCKET }}
          PREFIX: releases/frontend
        run: |
          rm -rf ./dist
          mkdir -p ./dist

          # latest í´ë”ì—ì„œ dist ë™ê¸°í™”
          aws s3 cp "s3://$BUCKET/$PREFIX/latest/" ./dist/ --recursive

          echo "Downloaded from s3://$BUCKET/$PREFIX/latest/"
          ls -la ./dist | head

      - name: Prepare release name
        id: meta
        run: echo "release=$(TZ='Asia/Seoul' date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Setup WireGuard
        uses: niklaskeerl/easy-wireguard-action@v2
        with:
          WG_CONFIG_FILE: ${{ secrets.WG_CONFIG }}
      
      # ----------------------------
      # 3. ì„œë²„ë¡œ ë°°í¬
      # ----------------------------
      - name: Deploy dist to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e
            echo "=== Frontend Deploy Start ==="

            TARGET_DIR="/home/ubuntu/frontend"
            BACKUP_DIR="/home/ubuntu/frontend_backup"

            # ë°±ì—… (ë¡¤ë°± ëŒ€ë¹„)
            rm -rf $BACKUP_DIR
            if [ -d "$TARGET_DIR" ]; then
              cp -r $TARGET_DIR $BACKUP_DIR
              echo "Backup completed"
            fi

            # ê¸°ì¡´ íŒŒì¼ ì œê±°
            rm -rf $TARGET_DIR
            mkdir -p $TARGET_DIR

      # ----------------------------
      # 4. dist ì—…ë¡œë“œ
      # ----------------------------
      - name: Upload dist files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          source: "dist/**"
          target: "/home/ubuntu/frontend"
          strip_components: 1
      
      # ----------------------------
      # 5. Nginx Reload
      # ----------------------------
      - name: Reload nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            sudo nginx -t
            sudo systemctl reload nginx
            echo "Nginx reloaded"

      # ----------------------------
      # 6. Health Check
      # ----------------------------
      - name: Health check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "Waiting for frontend to be available..."
            sleep 10

            if curl -sf http://localhost > /dev/null; then
              echo "Health check success"
              exit 0
            fi

            echo "Health check failed"
            exit 1

      # ----------------------------
      # 7. Rollback
      # ----------------------------
      - name: Rollback on failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            TARGET_DIR="/home/ubuntu/frontend"
            BACKUP_DIR="/home/ubuntu/frontend_backup"

            if [ -d "$BACKUP_DIR" ]; then
              rm -rf $TARGET_DIR
              mv $BACKUP_DIR $TARGET_DIR
              sudo systemctl reload nginx
              echo "Rollback completed"
            else
              echo "Rollback failed: no backup"
              exit 1
            fi
      
      # ----------------------------
      # 8. Discord ì•Œë¦¼
      # ----------------------------
      - name: Notify Discord - Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µ"
          description: "Frontend dist ë°°í¬ ì™„ë£Œ"

      - name: Notify Discord - Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "ğŸš¨ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
          description: "Frontend dist ë°°í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"