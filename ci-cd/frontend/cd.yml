name: Frontend CD

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰
  push:
    branches: [develop, main]
    paths-ignore:
      - "**.md"
      # - ".github/**"
      # - ".git*"

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  # ----------------------------
  # 1. Develop -> Dev ì„œë²„ ë°°í¬
  # ----------------------------
  deploy_dev:
    name: Deploy Frontend to Dev Server
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch'

    steps:
      # ----------------------------
      # 1. AWS ì¸ì¦
      # ----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      # ----------------------------
      # 2. S3ì—ì„œ ìµœì‹  dist ë‹¤ìš´ë¡œë“œ
      # ----------------------------
      - name: Download artifact from S3
        env:
          BUCKET: ${{ secrets.RELEASE_BUCKET }}
          PREFIX: releases/frontend
        run: |
          rm -rf ./dist
          mkdir -p ./dist

          # latest í´ë”ì—ì„œ dist ë™ê¸°í™”
          aws s3 cp "s3://$BUCKET/$PREFIX/latest/" ./dist/ --recursive

          echo "Downloaded from s3://$BUCKET/$PREFIX/latest/"
          ls -la ./dist | head

      - name: Setup WireGuard
        uses: niklaskeerl/easy-wireguard-action@v2
        with:
          WG_CONFIG_FILE: ${{ secrets.WG_CONFIG }}

      # ----------------------------
      # 3. ì„œë²„ì—ì„œ ê¸°ì¡´ íŒŒì¼ ë°±ì—…/ì •ë¦¬
      # ----------------------------
      - name: Prepare target directory (backup)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e
            echo "=== Frontend Deploy Start (DEV) ==="

            TARGET_DIR="/var/www/frontend"
            BACKUP_DIR="/var/www/frontend_backup"

            sudo rm -rf $BACKUP_DIR
            if [ -d "$TARGET_DIR" ]; then
              sudo cp -r $TARGET_DIR $BACKUP_DIR
              echo "Backup completed"
            fi

            sudo rm -rf $TARGET_DIR
            sudo mkdir -p $TARGET_DIR

            sudo chown -R ubuntu:ubuntu $TARGET_DIR
            sudo chmod -R 755 $TARGET_DIR

      # ----------------------------
      # 4. dist ì—…ë¡œë“œ
      # ----------------------------
      - name: Upload dist files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          source: "dist/**"
          target: "/var/www/frontend"
          strip_components: 1

      # ----------------------------
      # 5. Nginx Reload
      # ----------------------------
      - name: Reload nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            sudo nginx -t
            sudo systemctl reload nginx
            echo "Nginx reloaded"

      # ----------------------------
      # 6. Health Check
      # ----------------------------
      - name: Health check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "Waiting for frontend to be available..."
            sleep 10

            if curl -sf http://localhost > /dev/null; then
              echo "Health check success"
              exit 0
            fi

            echo "Health check failed"
            exit 1

      # ----------------------------
      # 7. Rollback
      # ----------------------------
      - name: Rollback on failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            TARGET_DIR="/var/www/frontend"
            BACKUP_DIR="/var/www/frontend_backup"

            if [ -d "$BACKUP_DIR" ]; then
              sudo rm -rf $TARGET_DIR
              sudo mv $BACKUP_DIR $TARGET_DIR
              sudo systemctl reload nginx
              echo "Rollback completed"
            else
              echo "Rollback failed: no backup"
              exit 1
            fi

      # ----------------------------
      # 8. Discord ì•Œë¦¼
      # ----------------------------
      - name: Notify Discord - Success
        if: steps.health_check.outcome == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "ğŸš€ [DEV] í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µ"
          description: "dist ë°°í¬ ì™„ë£Œ"

      - name: Notify Discord - Failure
        if: steps.health_check.outcome == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "ğŸš¨ [DEV] í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
          description: "dist ë°°í¬ ì‹¤íŒ¨"

      - name: Fail workflow if health check failed
        if: steps.health_check.outcome == 'failure'
        run: exit 1


  # ----------------------------
  # 2. Main -> Prod ì„œë²„ ë°°í¬
  # ----------------------------
  deploy_prod:
    name: Deploy Frontend to Prod Server
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      # ----------------------------
      # 1. AWS ì¸ì¦
      # ----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      # ----------------------------
      # 2. S3ì—ì„œ ìµœì‹  dist ë‹¤ìš´ë¡œë“œ
      # ----------------------------
      - name: Download artifact from S3
        env:
          BUCKET: ${{ secrets.RELEASE_BUCKET }}
          PREFIX: releases/frontend
        run: |
          rm -rf ./dist
          mkdir -p ./dist

          aws s3 cp "s3://$BUCKET/$PREFIX/latest/" ./dist/ --recursive

          echo "Downloaded from s3://$BUCKET/$PREFIX/latest/"
          ls -la ./dist | head

      - name: Setup WireGuard
        uses: niklaskeerl/easy-wireguard-action@v2
        with:
          WG_CONFIG_FILE: ${{ secrets.WG_CONFIG }}

      # ----------------------------
      # 3. ì„œë²„ì—ì„œ ê¸°ì¡´ íŒŒì¼ ë°±ì—…/ì •ë¦¬
      # ----------------------------
      - name: Prepare target directory (backup)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -e
            echo "=== Frontend Deploy Start (PROD) ==="

            TARGET_DIR="/var/www/frontend"
            BACKUP_DIR="/var/www/frontend_backup"

            sudo rm -rf $BACKUP_DIR
            if [ -d "$TARGET_DIR" ]; then
              sudo cp -r $TARGET_DIR $BACKUP_DIR
              echo "Backup completed"
            fi

            sudo rm -rf $TARGET_DIR
            sudo mkdir -p $TARGET_DIR

            sudo chown -R ubuntu:ubuntu $TARGET_DIR
            sudo chmod -R 755 $TARGET_DIR

      # ----------------------------
      # 4. dist ì—…ë¡œë“œ
      # ----------------------------
      - name: Upload dist files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: "dist/**"
          target: "/var/www/frontend"
          strip_components: 1

      # ----------------------------
      # 5. Nginx Reload
      # ----------------------------
      - name: Reload nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            sudo nginx -t
            sudo systemctl reload nginx
            echo "Nginx reloaded"

      # ----------------------------
      # 6. Health Check
      # ----------------------------
      - name: Health check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            echo "Waiting for frontend to be available..."
            sleep 10

            if curl -sf http://localhost > /dev/null; then
              echo "Health check success"
              exit 0
            fi

            echo "Health check failed"
            exit 1

      # ----------------------------
      # 7. Rollback
      # ----------------------------
      - name: Rollback on failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            TARGET_DIR="/var/www/frontend"
            BACKUP_DIR="/var/www/frontend_backup"

            if [ -d "$BACKUP_DIR" ]; then
              sudo rm -rf $TARGET_DIR
              sudo mv $BACKUP_DIR $TARGET_DIR
              sudo systemctl reload nginx
              echo "Rollback completed"
            else
              echo "Rollback failed: no backup"
              exit 1
            fi

      # ----------------------------
      # 8. Discord ì•Œë¦¼
      # ----------------------------
      - name: Notify Discord - Success
        if: steps.health_check.outcome == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "ğŸš€ [PROD] í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì„±ê³µ"
          description: "dist ë°°í¬ ì™„ë£Œ"

      - name: Notify Discord - Failure
        if: steps.health_check.outcome == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "ğŸš¨ [PROD] í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
          description: "dist ë°°í¬ ì‹¤íŒ¨"

      - name: Fail workflow if health check failed
        if: steps.health_check.outcome == 'failure'
        run: exit 1