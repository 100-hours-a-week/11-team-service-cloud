name: Backend CD

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰
  push:
    branches: [develop, main]
    paths-ignore:
      - "**.md"
      - ".github/**"
      - ".git*"

permissions:
  id-token: write # AWS OIDC ì¸ì¦ì— í•„ìš”
  contents: read
  actions: read

jobs:
  # ----------------------------
  # 1. Develop â†’ Dev ì„œë²„ ë°°í¬
  # ----------------------------
  deploy_dev:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      - name: Get timestamp (KST)
        id: timestamp
        run: echo "timestamp=$(TZ='Asia/Seoul' date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Deploy from S3 and Execute
        uses: appleboy/ssh-action@master
        env:
          RELEASE_BUCKET: ${{ secrets.RELEASE_BUCKET }}
          TIMESTAMP: ${{ steps.timestamp.outputs.timestamp }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_SCHEMA: ${{ secrets.DB_SCHEMA }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AI_SERVICE_URL: ${{ secrets.AI_SERVICE_URL }}
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          envs: RELEASE_BUCKET,TIMESTAMP,DB_HOST,DB_PORT,DB_SCHEMA,DB_USERNAME,DB_PASSWORD,AI_SERVICE_URL
          script: |
            cd /home/ubuntu/backend

            # S3 snapshotsì—ì„œ ìµœì‹  jar ë‹¤ìš´ë¡œë“œ
            NEW_JAR="app-$TIMESTAMP.jar"
            aws s3 cp s3://$RELEASE_BUCKET/snapshots/backend/latest/ ./ --recursive --exclude "*" --include "*.jar" --exclude "*-plain.jar"

            # ë‹¤ìš´ë¡œë“œí•œ jar íŒŒì¼ ì´ë¦„ ë³€ê²½
            DOWNLOADED_JAR=$(ls -t *.jar 2>/dev/null | grep -v "^app-" | grep -v "plain" | head -n 1)
            if [ -n "$DOWNLOADED_JAR" ]; then
              mv "$DOWNLOADED_JAR" "$NEW_JAR"
              echo "Renamed $DOWNLOADED_JAR to $NEW_JAR"
            fi

            # ì´ì „ ë²„ì „ ë°±ì—… (ë¡¤ë°±ìš©)
            PREVIOUS_JAR=$(ls -t app-*.jar 2>/dev/null | grep -v "^$NEW_JAR$" | head -n 1)
            echo "PREVIOUS_JAR=$PREVIOUS_JAR" > .deploy_info

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            if [ -f backend.pid ]; then
              OLD_PID=$(cat backend.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                kill $OLD_PID || true
                echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: PID $OLD_PID"
                sleep 3
              fi
              rm -f backend.pid
            fi

            # ìƒˆ ë²„ì „ ì‹¤í–‰
            AI_SERVICE_URL=$AI_SERVICE_URL DB_HOST=$DB_HOST DB_PORT=$DB_PORT DB_SCHEMA=$DB_SCHEMA DB_USERNAME=$DB_USERNAME DB_PASSWORD=$DB_PASSWORD \
              nohup java -jar "$NEW_JAR" > backend.log 2>&1 &
            echo $! > backend.pid
            echo "ìƒˆ ë²„ì „ ì‹¤í–‰: $NEW_JAR (PID: $(cat backend.pid))"

      - name: Health Check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "Health Check ì‹œì‘ (30ì´ˆ ëŒ€ê¸°)..."
            sleep 30

            for i in 1 2 3; do
              echo "Health Check ì‹œë„ $i/3"
              if curl -sf http://localhost:8080/api/health > /dev/null; then
                echo "Health Check ì„±ê³µ"
                exit 0
              fi
              sleep 10
            done

            echo "Health Check ì‹¤íŒ¨"
            exit 1

      - name: Rollback on failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        env:
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_SCHEMA: ${{ secrets.DB_SCHEMA }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          AI_SERVICE_URL: ${{ secrets.AI_SERVICE_URL }}
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          envs: DB_PORT,DB_SCHEMA,DB_USERNAME,DB_PASSWORD,AI_SERVICE_URL
          script: |
            cd /home/ubuntu/backend

            if [ -f backend.pid ]; then
              OLD_PID=$(cat backend.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                kill $OLD_PID || true
                sleep 3
              fi
              rm -f backend.pid
            fi

            source .deploy_info
            if [ -n "$PREVIOUS_JAR" ] && [ -f "$PREVIOUS_JAR" ]; then
              AI_SERVICE_URL=$AI_SERVICE_URL DB_PORT=$DB_PORT DB_SCHEMA=$DB_SCHEMA DB_USERNAME=$DB_USERNAME DB_PASSWORD=$DB_PASSWORD \
                nohup java -jar "$PREVIOUS_JAR" > backend.log 2>&1 &
              echo $! > backend.pid
              echo "ë¡¤ë°± ì™„ë£Œ: $PREVIOUS_JAR (PID: $(cat backend.pid))"
            else
              echo "ë¡¤ë°± ì‹¤íŒ¨: ì´ì „ ë²„ì „ ì—†ìŒ"
              exit 1
            fi

      - name: Notify Discord - Success
        if: steps.health_check.outcome == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "ğŸš€ [DEV] ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ"
          description: "app-${{ steps.timestamp.outputs.timestamp }}.jar"

      - name: Notify Discord - Failure
        if: steps.health_check.outcome == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "ğŸš¨ [DEV] ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
          description: "app-${{ steps.timestamp.outputs.timestamp }}.jar ë°°í¬ ì‹¤íŒ¨"

      - name: Fail workflow if health check failed
        if: steps.health_check.outcome == 'failure'
        run: exit 1

  # ----------------------------
  # 2. Main â†’ Prod ì„œë²„ ë°°í¬
  # ----------------------------
  deploy_prod:
    name: Deploy to Prod Server
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-2

      - name: Get timestamp (KST)
        id: timestamp
        run: echo "timestamp=$(TZ='Asia/Seoul' date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Deploy from S3 and Execute
        uses: appleboy/ssh-action@master
        env:
          RELEASE_BUCKET: ${{ secrets.RELEASE_BUCKET }}
          TIMESTAMP: ${{ steps.timestamp.outputs.timestamp }}
          DB_HOST: ${{ secrets.PROD_DB_HOST }}
          DB_PORT: ${{ secrets.PROD_DB_PORT }}
          DB_SCHEMA: ${{ secrets.PROD_DB_SCHEMA }}
          DB_USERNAME: ${{ secrets.PROD_DB_USER }}
          DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          AI_SERVICE_URL: ${{ secrets.AI_SERVICE_URL }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: RELEASE_BUCKET,TIMESTAMP,DB_HOST,DB_PORT,DB_SCHEMA,DB_USERNAME,DB_PASSWORD,AI_SERVICE_URL
          script: |
            cd /home/ubuntu/backend

            # S3 releasesì—ì„œ ìµœì‹  ë²„ì „ ì°¾ê¸°
            LATEST_VERSION=$(aws s3 ls s3://$RELEASE_BUCKET/releases/backend/ | sort | tail -1 | awk '{print $2}' | tr -d '/')
            echo "ìµœì‹  ë²„ì „: $LATEST_VERSION"

            # S3ì—ì„œ jar ë‹¤ìš´ë¡œë“œ
            NEW_JAR="app-$TIMESTAMP.jar"
            aws s3 cp s3://$RELEASE_BUCKET/releases/backend/$LATEST_VERSION/ ./ --recursive --exclude "*" --include "*.jar" --exclude "*-plain.jar"

            # ë‹¤ìš´ë¡œë“œí•œ jar íŒŒì¼ ì´ë¦„ ë³€ê²½
            DOWNLOADED_JAR=$(ls -t *.jar 2>/dev/null | grep -v "^app-" | grep -v "plain" | head -n 1)
            if [ -n "$DOWNLOADED_JAR" ]; then
              mv "$DOWNLOADED_JAR" "$NEW_JAR"
              echo "Renamed $DOWNLOADED_JAR to $NEW_JAR"
            fi

            # ì´ì „ ë²„ì „ ë°±ì—… (ë¡¤ë°±ìš©)
            PREVIOUS_JAR=$(ls -t app-*.jar 2>/dev/null | grep -v "^$NEW_JAR$" | head -n 1)
            echo "PREVIOUS_JAR=$PREVIOUS_JAR" > .deploy_info

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            if [ -f backend.pid ]; then
              OLD_PID=$(cat backend.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                kill $OLD_PID || true
                echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: PID $OLD_PID"
                sleep 3
              fi
              rm -f backend.pid
            fi

            # ìƒˆ ë²„ì „ ì‹¤í–‰
            AI_SERVICE_URL=$AI_SERVICE_URL DB_HOST=$DB_HOST DB_PORT=$DB_PORT DB_SCHEMA=$DB_SCHEMA DB_USERNAME=$DB_USERNAME DB_PASSWORD=$DB_PASSWORD \
              nohup java -jar "$NEW_JAR" > backend.log 2>&1 &
            echo $! > backend.pid
            echo "ìƒˆ ë²„ì „ ì‹¤í–‰: $NEW_JAR (PID: $(cat backend.pid))"

      - name: Health Check
        id: health_check
        uses: appleboy/ssh-action@master
        continue-on-error: true
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            echo "Health Check ì‹œì‘ (30ì´ˆ ëŒ€ê¸°)..."
            sleep 30

            for i in 1 2 3; do
              echo "Health Check ì‹œë„ $i/3"
              if curl -sf http://localhost:8080/api/health > /dev/null; then
                echo "Health Check ì„±ê³µ"
                exit 0
              fi
              sleep 10
            done

            echo "Health Check ì‹¤íŒ¨"
            exit 1

      - name: Rollback on failure
        if: steps.health_check.outcome == 'failure'
        uses: appleboy/ssh-action@master
        env:
          DB_HOST: ${{ secrets.PROD_DB_HOST }}
          DB_PORT: ${{ secrets.PROD_DB_PORT }}
          DB_SCHEMA: ${{ secrets.PROD_DB_SCHEMA }}
          DB_USERNAME: ${{ secrets.PROD_DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          AI_SERVICE_URL: ${{ secrets.AI_SERVICE_URL }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: DB_HOST,DB_PORT,DB_SCHEMA,DB_USERNAME,DB_PASSWORD,AI_SERVICE_URL
          script: |
            cd /home/ubuntu/backend

            if [ -f backend.pid ]; then
              OLD_PID=$(cat backend.pid)
              if ps -p $OLD_PID > /dev/null 2>&1; then
                kill $OLD_PID || true
                sleep 3
              fi
              rm -f backend.pid
            fi

            source .deploy_info
            if [ -n "$PREVIOUS_JAR" ] && [ -f "$PREVIOUS_JAR" ]; then
              AI_SERVICE_URL=$AI_SERVICE_URL DB_HOST=$DB_HOST DB_PORT=$DB_PORT DB_SCHEMA=$DB_SCHEMA DB_USERNAME=$DB_USERNAME DB_PASSWORD=$DB_PASSWORD \
                nohup java -jar "$PREVIOUS_JAR" > backend.log 2>&1 &
              echo $! > backend.pid
              echo "ë¡¤ë°± ì™„ë£Œ: $PREVIOUS_JAR (PID: $(cat backend.pid))"
            else
              echo "ë¡¤ë°± ì‹¤íŒ¨: ì´ì „ ë²„ì „ ì—†ìŒ"
              exit 1
            fi

      - name: Notify Discord - Success
        if: steps.health_check.outcome == 'success'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: "ğŸš€ [PROD] ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ"
          description: "app-${{ steps.timestamp.outputs.timestamp }}.jar"

      - name: Notify Discord - Failure
        if: steps.health_check.outcome == 'failure'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: "ğŸš¨ [PROD] ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨"
          description: "app-${{ steps.timestamp.outputs.timestamp }}.jar ë°°í¬ ì‹¤íŒ¨"

      - name: Fail workflow if health check failed
        if: steps.health_check.outcome == 'failure'
        run: exit 1
